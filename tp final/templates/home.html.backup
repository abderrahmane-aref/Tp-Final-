<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Home Page</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Arial', sans-serif; }
        body { background: #f4f7f8; }
        header {
            background: linear-gradient(135deg, #2b5876, #4e4376);
            color: white;
            padding: 25px 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        header h1 { font-size: 32px; }
        nav a {
            color: white;
            text-decoration: none;
            margin-left: 20px;
            font-weight: bold;
            transition: 0.3s;
        }
        nav a:hover { text-decoration: underline; }
        main { max-width: 1200px; margin: 40px auto; padding: 0 20px; }
        .welcome { font-size: 28px; margin-bottom: 30px; color: #333; text-align: center; }
        .cards { display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; margin-bottom: 40px; }
        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            width: 250px;
            text-align: center;
            transition: transform 0.3s;
            cursor: pointer;
        }
        .card:hover { transform: translateY(-10px); }
        .card h3 { margin-bottom: 15px; color: #2b5876; }
        .card p { color: #555; }
        
        /* Form Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        .modal-content h2 {
            margin-bottom: 20px;
            color: #2b5876;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 14px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn-primary {
            background: #2b5876;
            color: white;
        }
        .btn-primary:hover {
            background: #4e4376;
        }
        .btn-secondary {
            background: #ccc;
            color: #333;
        }
        .btn-secondary:hover {
            background: #999;
        }
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            display: none;
        }
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .search-box {
            margin-bottom: 20px;
            padding: 12px;
            border: 2px solid #2b5876;
            border-radius: 6px;
            width: 100%;
            max-width: 400px;
            font-size: 16px;
        }
        .patients-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .btn-add {
            background: #28a745;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        .btn-add:hover {
            background: #218838;
        }
        .notification-item {
            background: white;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #2b5876;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .notification-item.unread {
            background: #f0f8ff;
            border-left-color: #28a745;
        }
        .notification-title {
            font-weight: bold;
            color: #2b5876;
            margin-bottom: 5px;
        }
        .notification-message {
            color: #555;
            margin-bottom: 5px;
        }
        .notification-time {
            font-size: 12px;
            color: #999;
        }
        .notification-badge {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: bold;
        }
        .stats { display: flex; justify-content: space-around; flex-wrap: wrap; margin-bottom: 40px; gap: 20px; }
        .stat-box {
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
            flex: 1;
            min-width: 200px;
            text-align: center;
        }
        .stat-box h2 { color: #2b5876; margin-bottom: 10px; }
        .stat-box p { color: #555; font-size: 18px; }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        table th, table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd; }
        table th { background: #2b5876; color: white; }
        table tr:hover { background: #f1f1f1; }
        .btn-edit {
            background: #ffc107;
            color: #333;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 5px;
        }
        .btn-edit:hover {
            background: #ffb300;
        }
        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-delete:hover {
            background: #c82333;
        }
        footer { text-align: center; padding: 20px; margin-top: 50px; color: #777; font-size: 14px; }
    </style>
</head>
<body>

<header>
    <h1>Dashboard</h1>
    <nav>
        <a href="/home">Home</a>
        <a href="#" onclick="showPatientsSection()">Patients</a>
        <a href="#" onclick="showReportsSection()" id="reportsLink">Reports</a>
        <a href="#" onclick="showPrescriptionsSection()" id="prescriptionsLink">Prescriptions</a>
        <a href="#">Profile</a>
        <a href="#" onclick="logout()">Logout</a>
    </nav>
</header>

<main>
    <!-- Dashboard Section -->
    <div id="dashboardSection" class="section active">
        <div class="welcome" id="welcomeMessage">Welcome!</div>

        <div id="alertBox" class="alert"></div>

        <div class="cards" id="dashboardCards">
            <div class="card" onclick="showAddPatientModal()" id="addPatientCard">
                <h3>‚ûï Add Patient</h3>
                <p>Register new patient</p>
            </div>
            <div class="card" onclick="showPatientsSection()">
                <h3>üë• View Patients</h3>
                <p>See all patients</p>
            </div>
            <div class="card" onclick="showReportsSection()" id="reportsCard">
                <h3>üìã Reports</h3>
                <p>View detailed reports</p>
            </div>
            <div class="card" onclick="showPrescriptionsSection()" id="prescriptionsCard">
                <h3>üíä Prescriptions</h3>
                <p>View prescriptions</p>
            </div>
            <div class="card" onclick="showNotificationsSection()">
                <h3>üîî Notifications</h3>
                <p id="notificationCount">0 new notifications</p>
            </div>
        </div>

        <div class="stats">
            <div class="stat-box">
                <h2 id="totalPatients">0</h2>
                <p>Total Patients</p>
            </div>
            <div class="stat-box">
                <h2 id="todayAppointments">10</h2>
                <p>Appointments Today</p>
            </div>
            <div class="stat-box">
                <h2 id="newReports">0</h2>
                <p>New Reports</p>
            </div>
        </div>

        <h3 style="margin-bottom: 20px; color: #2b5876;">üìã Recent Patients</h3>
        <table id="recentPatientsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Date of Birth</th>
                    <th>Gender</th>
                    <th>Last Visit</th>
                </tr>
            </thead>
            <tbody id="recentPatientsBody">
                <tr><td colspan="6" style="text-align:center;">Loading patients...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- All Patients Section -->
    <div id="allPatientsSection" class="section">
        <div class="patients-header">
            <h2 style="color: #2b5876;">üë• All Patients</h2>
            <button class="btn-add" onclick="showAddPatientModal()">‚ûï Add New Patient</button>
        </div>
        
        <input type="text" id="searchBox" class="search-box" placeholder="üîç Search patients by name..." onkeyup="filterPatients()">
        
        <table id="patientsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Date of Birth</th>
                    <th>Gender</th>
                    <th>Last Visit</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="patientsTableBody">
                <tr><td colspan="8" style="text-align:center;">Loading all patients...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Notifications Section -->
    <div id="notificationsSection" class="section">
        <div class="patients-header">
            <h2 style="color: #2b5876;">üîî Notifications</h2>
        </div>
        
        <div id="notificationsList">
            <p style="text-align:center; padding: 20px;">Loading notifications...</p>
        </div>
    </div>

    <!-- Reports Section -->
    <div id="reportsSection" class="section">
        <div class="patients-header">
            <h2 style="color: #2b5876;">üìã Medical Reports</h2>
            <button class="btn-add" onclick="showAddReportModal()" id="addReportBtn">‚ûï Add New Report</button>
        </div>
        
        <table id="reportsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Patient Name</th>
                    <th>Report Type</th>
                    <th>Diagnosis</th>
                    <th>Treatment</th>
                    <th>Medications</th>
                    <th>Created By</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="reportsTableBody">
                <tr><td colspan="8" style="text-align:center;">Loading reports...</td></tr>
            </tbody>
        </table>
    </div>

    <!-- Prescriptions Section -->
    <div id="prescriptionsSection" class="section">
        <div class="patients-header">
            <h2 style="color: #2b5876;">üíä Prescriptions</h2>
            <button class="btn-add" onclick="showAddPrescriptionModal()" id="addPrescriptionBtn">‚ûï Add New Prescription</button>
        </div>
        
        <table id="prescriptionsTable">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Patient Name</th>
                    <th>Medication</th>
                    <th>Dosage</th>
                    <th>Frequency</th>
                    <th>Duration</th>
                    <th>Instructions</th>
                    <th>Prescribed By</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody id="prescriptionsTableBody">
                <tr><td colspan="9" style="text-align:center;">Loading prescriptions...</td></tr>
            </tbody>
        </table>
    </div>
</main>

<!-- Add Patient Modal -->
<div id="addPatientModal" class="modal">
    <div class="modal-content">
        <h2>‚ûï Add New Patient</h2>
        <form id="addPatientForm">
            <div class="form-group">
                <label for="firstName">First Name *</label>
                <input type="text" id="firstName" name="first_name" required>
            </div>
            <div class="form-group">
                <label for="lastName">Last Name *</label>
                <input type="text" id="lastName" name="last_name" required>
            </div>
            <div class="form-group">
                <label for="dob">Date of Birth *</label>
                <input type="date" id="dob" name="dob" required>
            </div>
            <div class="form-group">
                <label for="sex">Gender *</label>
                <select id="sex" name="sex" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="form-group">
                <label for="notes">Notes</label>
                <textarea id="notes" name="notes" rows="3" placeholder="Any special notes..."></textarea>
            </div>
            <div>
                <button type="submit" class="btn btn-primary">üíæ Save Patient</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddPatientModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Patient Modal -->
<div id="editPatientModal" class="modal">
    <div class="modal-content">
        <h2>‚úèÔ∏è Edit Patient</h2>
        <form id="editPatientForm">
            <input type="hidden" id="editPatientId" name="patient_id">
            <div class="form-group">
                <label for="editFirstName">First Name *</label>
                <input type="text" id="editFirstName" name="first_name" required>
            </div>
            <div class="form-group">
                <label for="editLastName">Last Name *</label>
                <input type="text" id="editLastName" name="last_name" required>
            </div>
            <div class="form-group">
                <label for="editDob">Date of Birth *</label>
                <input type="date" id="editDob" name="dob" required>
            </div>
            <div class="form-group">
                <label for="editSex">Gender *</label>
                <select id="editSex" name="sex" required>
                    <option value="">Select Gender</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>
            </div>
            <div class="form-group">
                <label for="editNotes">Notes</label>
                <textarea id="editNotes" name="notes" rows="3" placeholder="Any special notes..."></textarea>
            </div>
            <div>
                <button type="submit" class="btn btn-primary">üíæ Update Patient</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditPatientModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Report Modal -->
<div id="addReportModal" class="modal">
    <div class="modal-content">
        <h2>‚ûï Add Medical Report</h2>
        <form id="addReportForm">
            <div class="form-group">
                <label for="reportPatientId">Patient *</label>
                <select id="reportPatientId" name="patient_id" required>
                    <option value="">Select Patient</option>
                </select>
            </div>
            <div class="form-group">
                <label for="reportType">Report Type *</label>
                <select id="reportType" name="report_type" required>
                    <option value="">Select Type</option>
                    <option value="General Checkup">General Checkup</option>
                    <option value="Lab Results">Lab Results</option>
                    <option value="X-Ray">X-Ray</option>
                    <option value="CT Scan">CT Scan</option>
                    <option value="MRI">MRI</option>
                    <option value="Blood Test">Blood Test</option>
                    <option value="Prescription">Prescription</option>
                    <option value="Follow-up">Follow-up</option>
                </select>
            </div>
            <div class="form-group">
                <label for="diagnosis">Diagnosis</label>
                <textarea id="diagnosis" name="diagnosis" rows="2" placeholder="Patient diagnosis..."></textarea>
            </div>
            <div class="form-group">
                <label for="treatment">Treatment</label>
                <textarea id="treatment" name="treatment" rows="2" placeholder="Recommended treatment..."></textarea>
            </div>
            <div class="form-group">
                <label for="medications">Medications</label>
                <textarea id="medications" name="medications" rows="2" placeholder="Prescribed medications..."></textarea>
            </div>
            <div class="form-group">
                <label for="reportNotes">Notes</label>
                <textarea id="reportNotes" name="notes" rows="2" placeholder="Additional notes..."></textarea>
            </div>
            <div>
                <button type="submit" class="btn btn-primary">üíæ Save Report</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddReportModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Prescription Modal -->
<div id="addPrescriptionModal" class="modal">
    <div class="modal-content">
        <h2>‚ûï Add New Prescription</h2>
        <form id="addPrescriptionForm">
            <div class="form-group">
                <label for="prescriptionPatientId">Patient *</label>
                <select id="prescriptionPatientId" name="patient_id" required>
                    <option value="">Select Patient</option>
                </select>
            </div>
            <div class="form-group">
                <label for="medicationName">Medication Name *</label>
                <input type="text" id="medicationName" name="medication_name" required placeholder="e.g., Amoxicillin">
            </div>
            <div class="form-group">
                <label for="dosage">Dosage *</label>
                <input type="text" id="dosage" name="dosage" required placeholder="e.g., 500mg">
            </div>
            <div class="form-group">
                <label for="frequency">Frequency *</label>
                <input type="text" id="frequency" name="frequency" required placeholder="e.g., 3 times a day">
            </div>
            <div class="form-group">
                <label for="duration">Duration *</label>
                <input type="text" id="duration" name="duration" required placeholder="e.g., 7 days">
            </div>
            <div class="form-group">
                <label for="instructions">Instructions</label>
                <textarea id="instructions" name="instructions" rows="3" placeholder="Take after meals..."></textarea>
            </div>
            <div>
                <button type="submit" class="btn btn-primary">üíæ Save Prescription</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddPrescriptionModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<footer>
    ¬© 2025 My Dashboard. All rights reserved.
</footer>

<script>
    // Check authentication
    const role = sessionStorage.getItem("role");
    const username = sessionStorage.getItem("username");

    if(!role) {
        alert("Please login first!");
        window.location.href = "/";
    } else {
        document.getElementById("welcomeMessage").innerText = `Welcome, ${role}! (${username})`;
        // Set role-based permissions
        applyRolePermissions();
    }

    // ÿØÿßŸÑÿ© ŸÖÿ≥ÿßÿπÿØÿ© ŸÑÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸáŸäÿØÿ±ÿ≤ ŸÑŸÑÿ∑ŸÑÿ®ÿßÿ™ - Helper function to add headers to requests
    // Ÿáÿ∞Ÿá ÿßŸÑÿØÿßŸÑÿ© ÿ™ÿ∂ŸäŸÅ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÑŸÉŸÑ ÿ∑ŸÑÿ® API
    function getAuthHeaders() {
        return {
            'X-User-Role': role,
            'X-User-Name': username
        };
    }

    // Apply permissions based on role
    function applyRolePermissions() {
        const isDoctor = role === "Doctor";
        const isNurse = role === "Nurse";
        const isPharmacist = role === "Pharmacist";

        // Hide/show elements based on role
        if (isNurse) {
            // Nurse can ONLY VIEW patients and reports (READ ONLY - NO add/edit/delete)
            hideElement('addPatientCard');
            hideElement('addReportBtn');
            hideElement('prescriptionsLink');
            hideElement('prescriptionsCard');
            hideElement('addPrescriptionBtn');
            // Nurse CANNOT add/edit/delete patients - only view
        } else if (isPharmacist) {
            // Pharmacist can ONLY VIEW prescriptions (READ ONLY)
            hideElement('addPatientCard');
            hideElement('reportsLink');
            hideElement('reportsCard');
            hideElement('addReportBtn');
            hideElement('addPrescriptionBtn');
            // Hide patients view
            const patientsCard = document.querySelector('.card[onclick="showPatientsSection()"]');
            if (patientsCard) patientsCard.style.display = 'none';
            const patientsLink = document.querySelector('a[onclick="showPatientsSection()"]');
            if (patientsLink) patientsLink.style.display = 'none';
            const notifCard = document.querySelector('.card[onclick="showNotificationsSection()"]');
            if (notifCard) notifCard.style.display = 'none';
            setTimeout(() => showPrescriptionsSection(), 100);
        } else if (isDoctor) {
            // Doctor has FULL access: add/edit/delete patients, create reports, ADD PRESCRIPTIONS
            // Show all features including prescription button
        }
    }

    function hideElement(id) {
        const element = document.getElementById(id);
        if (element) {
            element.style.display = 'none';
        }
    }

    function logout() {
        sessionStorage.clear();
        window.location.href = "/";
    }

    // Load patients and reports on page load
    window.onload = function() {
        loadPatients();
        loadNotifications();
        loadReports();
        loadPrescriptions();
        showDashboardSection(); // Show dashboard by default
    };

    // Show/Hide sections
    function showDashboardSection() {
        document.getElementById('dashboardSection').classList.add('active');
        document.getElementById('allPatientsSection').classList.remove('active');
        document.getElementById('notificationsSection').classList.remove('active');
        document.getElementById('reportsSection').classList.remove('active');
        document.getElementById('prescriptionsSection').classList.remove('active');
    }

    function showPatientsSection() {
        document.getElementById('dashboardSection').classList.remove('active');
        document.getElementById('allPatientsSection').classList.add('active');
        document.getElementById('notificationsSection').classList.remove('active');
        document.getElementById('reportsSection').classList.remove('active');
        document.getElementById('prescriptionsSection').classList.remove('active');
        loadPatients(); // Refresh patients list
    }

    function showNotificationsSection() {
        document.getElementById('dashboardSection').classList.remove('active');
        document.getElementById('allPatientsSection').classList.remove('active');
        document.getElementById('notificationsSection').classList.add('active');
        document.getElementById('reportsSection').classList.remove('active');
        document.getElementById('prescriptionsSection').classList.remove('active');
        loadNotifications(); // Refresh notifications
    }

    function showReportsSection() {
        document.getElementById('dashboardSection').classList.remove('active');
        document.getElementById('allPatientsSection').classList.remove('active');
        document.getElementById('notificationsSection').classList.remove('active');
        document.getElementById('reportsSection').classList.add('active');
        document.getElementById('prescriptionsSection').classList.remove('active');
        loadReports(); // Load reports
    }

    function showPrescriptionsSection() {
        document.getElementById('dashboardSection').classList.remove('active');
        document.getElementById('allPatientsSection').classList.remove('active');
        document.getElementById('notificationsSection').classList.remove('active');
        document.getElementById('reportsSection').classList.remove('active');
        document.getElementById('prescriptionsSection').classList.add('active');
        loadPrescriptions(); // Load prescriptions
    }

    // Store all patients globally for filtering
    let allPatients = [];

    // Load all patients from database
    // ÿ™ÿ≠ŸÖŸäŸÑ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑŸÖÿ±ÿ∂Ÿâ ŸÖŸÜ ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
    async function loadPatients() {
        try {
            const response = await fetch('/api/patients', {
                headers: getAuthHeaders()
            });
            const data = await response.json();
            
            if (data.success) {
                allPatients = data.data;
                displayPatients(data.data);
                displayRecentPatients(data.data.slice(0, 5)); // Show only 5 recent
                document.getElementById('totalPatients').innerText = data.data.length;
                
                // Update patient dropdown in report form
                updatePatientDropdown(data.data);
                updatePrescriptionPatientDropdown(data.data);
            }
        } catch (error) {
            console.error('Error loading patients:', error);
            showAlert('Error loading patients', 'error');
        }
    }

    // Update patient dropdown
    function updatePatientDropdown(patients) {
        const select = document.getElementById('reportPatientId');
        if (select) {
            select.innerHTML = '<option value="">Select Patient</option>';
            patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.first_name} ${patient.last_name} (ID: ${patient.id})`;
                select.appendChild(option);
            });
        }
    }

    // Update prescription patient dropdown
    function updatePrescriptionPatientDropdown(patients) {
        const select = document.getElementById('prescriptionPatientId');
        if (select) {
            select.innerHTML = '<option value="">Select Patient</option>';
            patients.forEach(patient => {
                const option = document.createElement('option');
                option.value = patient.id;
                option.textContent = `${patient.first_name} ${patient.last_name} (ID: ${patient.id})`;
                select.appendChild(option);
            });
        }
    }

    // Display recent patients in dashboard
    function displayRecentPatients(patients) {
        const tbody = document.getElementById('recentPatientsBody');
        
        if (patients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No patients found</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        patients.forEach(patient => {
            const row = `
                <tr>
                    <td>${patient.id}</td>
                    <td>${patient.first_name}</td>
                    <td>${patient.last_name}</td>
                    <td>${patient.dob}</td>
                    <td>${patient.sex}</td>
                    <td>${patient.last_visit || 'N/A'}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // Display patients in table
    function displayPatients(patients) {
        const tbody = document.getElementById('patientsTableBody');
        const isNurse = role === "Nurse";
        
        if (patients.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No patients found</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        patients.forEach(patient => {
            let actionsHtml = '';
            if (!isNurse) {
                actionsHtml = `
                    <button class="btn-edit" onclick="editPatient(${patient.id})">‚úèÔ∏è Edit</button>
                    <button class="btn-delete" onclick="deletePatient(${patient.id})">üóëÔ∏è Delete</button>
                `;
            } else {
                actionsHtml = '<span style="color: #999;">View Only</span>';
            }
            
            const row = `
                <tr>
                    <td>${patient.id}</td>
                    <td>${patient.first_name}</td>
                    <td>${patient.last_name}</td>
                    <td>${patient.dob}</td>
                    <td>${patient.sex}</td>
                    <td>${patient.last_visit || 'N/A'}</td>
                    <td>${patient.notes || 'No notes'}</td>
                    <td>${actionsHtml}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // Filter patients by search
    function filterPatients() {
        const searchTerm = document.getElementById('searchBox').value.toLowerCase();
        
        const filteredPatients = allPatients.filter(patient => {
            const fullName = `${patient.first_name} ${patient.last_name}`.toLowerCase();
            return fullName.includes(searchTerm) || 
                   patient.first_name.toLowerCase().includes(searchTerm) ||
                   patient.last_name.toLowerCase().includes(searchTerm);
        });
        
        displayPatients(filteredPatients);
    }

    // Show add patient modal
    function showAddPatientModal() {
        document.getElementById('addPatientModal').style.display = 'flex';
    }

    // Close add patient modal
    function closeAddPatientModal() {
        document.getElementById('addPatientModal').style.display = 'none';
        document.getElementById('addPatientForm').reset();
    }

    // Handle add patient form submission
    document.getElementById('addPatientForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        
        try {
            const response = await fetch('/api/patients', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('‚úÖ Patient added successfully!', 'success');
                closeAddPatientModal();
                loadPatients(); // Reload patients list
                loadNotifications(); // Reload notifications to show new patient notification
                showDashboardSection(); // Go back to dashboard
            } else {
                showAlert('‚ùå ' + data.message, 'error');
            }
        } catch (error) {
            console.error('Error adding patient:', error);
            showAlert('‚ùå Error adding patient', 'error');
        }
    });

    // Edit patient
    async function editPatient(patientId) {
        try {
            const response = await fetch(`/api/patients/${patientId}`);
            const data = await response.json();
            
            if (data.success) {
                const patient = data.data;
                document.getElementById('editPatientId').value = patient.id;
                document.getElementById('editFirstName').value = patient.first_name;
                document.getElementById('editLastName').value = patient.last_name;
                document.getElementById('editDob').value = patient.dob;
                document.getElementById('editSex').value = patient.sex;
                document.getElementById('editNotes').value = patient.notes || '';
                
                document.getElementById('editPatientModal').style.display = 'flex';
            } else {
                showAlert('‚ùå Patient not found', 'error');
            }
        } catch (error) {
            console.error('Error loading patient:', error);
            showAlert('‚ùå Error loading patient', 'error');
        }
    }

    // Close edit patient modal
    function closeEditPatientModal() {
        document.getElementById('editPatientModal').style.display = 'none';
        document.getElementById('editPatientForm').reset();
    }

    // Handle edit patient form submission
    document.getElementById('editPatientForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const patientId = document.getElementById('editPatientId').value;
        const formData = new FormData(this);
        
        try {
            const response = await fetch(`/api/patients/${patientId}`, {
                method: 'PUT',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('‚úÖ Patient updated successfully!', 'success');
                closeEditPatientModal();
                loadPatients(); // Reload patients list
                loadNotifications(); // Reload notifications
            } else {
                showAlert('‚ùå ' + data.message, 'error');
            }
        } catch (error) {
            console.error('Error updating patient:', error);
            showAlert('‚ùå Error updating patient', 'error');
        }
    });

    // Delete patient
    async function deletePatient(patientId) {
        if (!confirm('Are you sure you want to delete this patient? This action cannot be undone.')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/patients/${patientId}`, {
                method: 'DELETE'
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('‚úÖ Patient deleted successfully!', 'success');
                loadPatients(); // Reload patients list
                loadNotifications(); // Reload notifications
            } else {
                showAlert('‚ùå ' + data.message, 'error');
            }
        } catch (error) {
            console.error('Error deleting patient:', error);
            showAlert('‚ùå Error deleting patient', 'error');
        }
    }

    // Load notifications from database
    async function loadNotifications() {
        try {
            const response = await fetch('/api/notifications');
            const data = await response.json();
            
            if (data.success) {
                displayNotifications(data.data);
                updateNotificationCount(data.unread_count);
            }
        } catch (error) {
            console.error('Error loading notifications:', error);
        }
    }

    // Display notifications
    function displayNotifications(notifications) {
        const container = document.getElementById('notificationsList');
        
        if (notifications.length === 0) {
            container.innerHTML = '<p style="text-align:center; padding: 20px; color: #999;">No notifications yet</p>';
            return;
        }

        let html = '';
        notifications.forEach(notif => {
            const unreadClass = notif.is_read === 0 ? 'unread' : '';
            const date = new Date(notif.created_at);
            const timeStr = date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            html += `
                <div class="notification-item ${unreadClass}">
                    <div class="notification-title">
                        ${notif.title}
                        ${notif.is_read === 0 ? '<span class="notification-badge">NEW</span>' : ''}
                    </div>
                    <div class="notification-message">${notif.message}</div>
                    <div class="notification-time">üïí ${timeStr}</div>
                </div>
            `;
        });
        
        container.innerHTML = html;
    }

    // Update notification count in card
    function updateNotificationCount(count) {
        const countElement = document.getElementById('notificationCount');
        if (count === 0) {
            countElement.textContent = 'No new notifications';
        } else if (count === 1) {
            countElement.textContent = '1 new notification';
        } else {
            countElement.textContent = `${count} new notifications`;
        }
    }

    // Load reports
    async function loadReports() {
        try {
            const response = await fetch('/api/reports');
            const data = await response.json();
            
            if (data.success) {
                displayReports(data.data);
                document.getElementById('newReports').innerText = data.data.length;
            }
        } catch (error) {
            console.error('Error loading reports:', error);
            showAlert('Error loading reports', 'error');
        }
    }

    // Display reports
    function displayReports(reports) {
        const tbody = document.getElementById('reportsTableBody');
        
        if (reports.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No reports found</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        reports.forEach(report => {
            const date = new Date(report.created_at);
            const dateStr = date.toLocaleDateString('en-US', { 
                year: 'numeric',
                month: 'short', 
                day: 'numeric'
            });
            
            const row = `
                <tr>
                    <td>${report.id}</td>
                    <td>${report.first_name} ${report.last_name}</td>
                    <td>${report.report_type}</td>
                    <td>${report.diagnosis || 'N/A'}</td>
                    <td>${report.treatment || 'N/A'}</td>
                    <td>${report.medications || 'N/A'}</td>
                    <td>${report.created_by}</td>
                    <td>${dateStr}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // Show add report modal
    function showAddReportModal() {
        loadPatients(); // Make sure patients are loaded
        document.getElementById('addReportModal').style.display = 'flex';
    }

    // Close add report modal
    function closeAddReportModal() {
        document.getElementById('addReportModal').style.display = 'none';
        document.getElementById('addReportForm').reset();
    }

    // Handle add report form submission
    document.getElementById('addReportForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        formData.append('created_by', username); // Add current user
        
        try {
            const response = await fetch('/api/reports', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('‚úÖ Report added successfully!', 'success');
                closeAddReportModal();
                loadReports(); // Reload reports
                loadNotifications(); // Reload notifications
            } else {
                showAlert('‚ùå ' + data.message, 'error');
            }
        } catch (error) {
            console.error('Error adding report:', error);
            showAlert('‚ùå Error adding report', 'error');
        }
    });

    // Load prescriptions
    async function loadPrescriptions() {
        try {
            const response = await fetch('/api/prescriptions');
            const data = await response.json();
            
            if (data.success) {
                displayPrescriptions(data.data);
            }
        } catch (error) {
            console.error('Error loading prescriptions:', error);
            showAlert('Error loading prescriptions', 'error');
        }
    }

    // Display prescriptions
    function displayPrescriptions(prescriptions) {
        const tbody = document.getElementById('prescriptionsTableBody');
        
        if (prescriptions.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;">No prescriptions found</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        prescriptions.forEach(prescription => {
            const date = new Date(prescription.created_at);
            const dateStr = date.toLocaleDateString('en-US', { 
                year: 'numeric',
                month: 'short', 
                day: 'numeric'
            });
            
            const row = `
                <tr>
                    <td>${prescription.id}</td>
                    <td>${prescription.first_name} ${prescription.last_name}</td>
                    <td>${prescription.medication_name}</td>
                    <td>${prescription.dosage}</td>
                    <td>${prescription.frequency}</td>
                    <td>${prescription.duration}</td>
                    <td>${prescription.instructions || 'N/A'}</td>
                    <td>${prescription.prescribed_by}</td>
                    <td>${dateStr}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // Show add prescription modal
    function showAddPrescriptionModal() {
        loadPatients(); // Make sure patients are loaded
        document.getElementById('addPrescriptionModal').style.display = 'flex';
    }

    // Close add prescription modal
    function closeAddPrescriptionModal() {
        document.getElementById('addPrescriptionModal').style.display = 'none';
        document.getElementById('addPrescriptionForm').reset();
    }

    // Handle add prescription form submission
    document.getElementById('addPrescriptionForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        formData.append('prescribed_by', username); // Add current user
        
        try {
            const response = await fetch('/api/prescriptions', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('‚úÖ Prescription added successfully!', 'success');
                closeAddPrescriptionModal();
                loadPrescriptions(); // Reload prescriptions
                loadNotifications(); // Reload notifications
            } else {
                showAlert('‚ùå ' + data.message, 'error');
            }
        } catch (error) {
            console.error('Error adding prescription:', error);
            showAlert('‚ùå Error adding prescription', 'error');
        }
    });

    // Show alert message
    function showAlert(message, type) {
        const alertBox = document.getElementById('alertBox');
        alertBox.className = `alert alert-${type}`;
        alertBox.textContent = message;
        alertBox.style.display = 'block';
        
        setTimeout(() => {
            alertBox.style.display = 'none';
        }, 5000);
    }
</script>

</body>
</html>
